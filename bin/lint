#!/bin/bash

# Lint and auto-fix Python and Rust code
cd "$(dirname "$0")/.."

echo "üîç Linting and fixing code..."
echo "============================="

# Python linting with black, flake8, and isort
if command -v python3 &> /dev/null; then
    echo ""
    echo "üêç Python formatting with black..."
    python3 -m black src/ tests/ || echo "‚ö†Ô∏è  black not installed, run: pip install black"
    
    echo ""
    echo "üêç Python import sorting with isort..."
    python3 -m isort src/ tests/ || echo "‚ö†Ô∏è  isort not installed, run: pip install isort"
    
    echo ""
    echo "üêç Python linting with flake8..."
    python3 -m flake8 src/ tests/ || echo "‚ö†Ô∏è  flake8 not installed, run: pip install flake8"
    PYTHON_EXIT=$?
else
    echo "‚ö†Ô∏è  Skipping Python lint (python3 not installed)"
    PYTHON_EXIT=0
fi

# Rust linting with clippy and formatting
if command -v cargo &> /dev/null; then
    echo ""
    echo "ü¶Ä Rust formatting with rustfmt..."
    cargo fmt
    
    echo ""
    echo "ü¶Ä Rust linting with clippy..."
    cargo clippy --fix --allow-dirty --allow-staged -- -W clippy::all
    RUST_EXIT=$?
else
    echo "‚ö†Ô∏è  Skipping Rust lint (cargo not installed)"
    RUST_EXIT=0
fi

echo ""
if [ $PYTHON_EXIT -eq 0 ] && [ $RUST_EXIT -eq 0 ]; then
    echo "‚úÖ All linting complete!"
    exit 0
else
    echo "‚ö†Ô∏è  Some linting issues remain"
    exit 1
fi